<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador Cirineo v5.3 (Texto Centrado Puro)</title>
    
    <link rel="icon" href="https://raw.githubusercontent.com/jesusvn1993mplvt3-ai/CIRINEO/refs/heads/main/icon.ico">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { background-color: #f1f5f9; min-height: 100vh; font-family: 'Roboto Condensed', sans-serif; overflow: hidden; }
        @media (max-width: 1024px) { body { height: auto; overflow-y: auto; overflow-x: hidden; } }
        
        #reader a, #reader-hidden a { display: none !important; }

        /* --- CLASES CRÍTICAS PARA EL PDF --- */
        .pdf-fixed-container {
            width: 6in;
            height: 4in;
            background: white;
            page-break-after: always;
            break-after: page;
            margin: 0;
            overflow: hidden;
            position: relative;
            box-sizing: border-box;
            display: flex;
        }

        .preview-wrapper {
            width: 100%;
            max-width: 600px; 
            aspect-ratio: 6/4;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            background: white;
        }

        /* --- ESTRUCTURA DE LA ETIQUETA --- */
        .label-layout {
            width: 100%;
            height: 100%;
            display: flex;
            border: 1px solid #ddd;
            padding: 0.25in;
            box-sizing: border-box;
            background: white;
        }

        .col-img { width: 25%; display: flex; align-items: center; justify-content: center; border-right: 2px solid #000; padding-right: 5px; overflow: hidden; }
        .col-img img { width: 100%; height: 100%; object-fit: contain; }

        .col-data { width: 60%; display: flex; flex-direction: column; border-right: 2px solid #000; }

        .col-barcode { width: 15%; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }

        .lbl-row { display: flex; border-bottom: 2px solid #000; width: 100%; }
        .lbl-row:last-child { border-bottom: none; }
        .lbl-col { border-right: 2px solid #000; padding: 2px 4px; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
        .lbl-col:last-child { border-right: none; }
        
        .lbl-title { font-size: 10px; font-weight: 700; color: #555; text-transform: uppercase; line-height: 1; margin-bottom: 1px; }
        .lbl-big { font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 32px; line-height: 0.9; color: #000; }
        .lbl-medium { font-family: 'Oswald', sans-serif; font-weight: 700; font-size: 20px; line-height: 1; color: #000; }
        .lbl-std { font-size: 14px; font-weight: 700; color: #000; line-height: 1.1; }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409",
            measurementId: "G-B7YLM78RVW"
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const FieldValue = firebase.firestore.FieldValue; 

        const Icon = ({ name, size = 18, className }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (containerRef.current && lucide.icons[name]) {
                    containerRef.current.innerHTML = lucide.icons[name].toSvg({ width: size, height: size, class: className });
                }
            }, [name, size, className]);
            return <div ref={containerRef} className="inline-block" style={{ width: size, height: size }}></div>;
        };

        // --- NUEVO MODAL DE GESTIÓN DE FUENTES DE IMÁGENES (DB) ---
        const ImageConfigModal = ({ isVisible, onClose }) => {
            const [sources, setSources] = useState([]);
            const [newName, setNewName] = useState('');
            const [newUrl, setNewUrl] = useState('');
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                if(isVisible) {
                    const unsubscribe = db.collection('app_config').doc('imagenes')
                        .onSnapshot(doc => {
                            if(doc.exists && doc.data().sources) {
                                setSources(doc.data().sources);
                            } else {
                                setSources([]);
                            }
                        });
                    return () => unsubscribe();
                }
            }, [isVisible]);

            const handleAdd = async () => {
                if(!newName || !newUrl) return alert("Llena ambos campos");
                let cleanUrl = newUrl.trim();
                if(cleanUrl.endsWith('/')) cleanUrl = cleanUrl.slice(0, -1);
                const newEntry = { id: Date.now(), name: newName, url: cleanUrl };
                const updatedSources = [...sources, newEntry];
                setLoading(true);
                try {
                    await db.collection('app_config').doc('imagenes').set({ sources: updatedSources }, { merge: true });
                    setNewName('');
                    setNewUrl('');
                } catch(e) { alert("Error al guardar: " + e.message); }
                setLoading(false);
            };

            const handleDelete = async (idToDelete) => {
                if(!confirm("¿Eliminar esta fuente?")) return;
                const updatedSources = sources.filter(s => s.id !== idToDelete);
                try {
                    await db.collection('app_config').doc('imagenes').set({ sources: updatedSources });
                } catch(e) { alert("Error: " + e.message); }
            };

            if(!isVisible) return null;

            return (
                <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="bg-slate-800 text-white p-3 font-bold flex justify-between items-center">
                            <span className="flex items-center gap-2"><Icon name="images"/> FUENTES DE IMÁGENES</span>
                            <button onClick={onClose}><Icon name="x"/></button>
                        </div>
                        <div className="p-4 bg-blue-50 border-b border-blue-100 text-xs text-blue-800">
                            <p>Agrega repositorios de GitHub, servidores locales o carpetas públicas.</p>
                        </div>
                        <div className="p-4 flex flex-col gap-2 border-b">
                            <div className="flex gap-2">
                                <input className="border p-2 rounded text-sm w-1/3" placeholder="Nombre" value={newName} onChange={e => setNewName(e.target.value)} />
                                <input className="border p-2 rounded text-sm w-2/3" placeholder="URL Base" value={newUrl} onChange={e => setNewUrl(e.target.value)} />
                            </div>
                            <button onClick={handleAdd} disabled={loading} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded text-sm flex justify-center items-center gap-2">
                                {loading ? 'GUARDANDO...' : <><Icon name="plus" size={16}/> AGREGAR FUENTE</>}
                            </button>
                        </div>
                        <div className="flex-grow overflow-y-auto p-4 space-y-2 bg-slate-50">
                            {sources.map((source, index) => (
                                <div key={source.id} className="bg-white border rounded p-3 flex justify-between items-center shadow-sm">
                                    <div className="overflow-hidden">
                                        <div className="font-bold text-sm flex items-center gap-2">
                                            <span className="bg-slate-200 text-slate-600 px-1.5 rounded text-[10px]">{index + 1}</span>
                                            {source.name}
                                        </div>
                                        <div className="text-xs text-slate-500 truncate mt-1" title={source.url}>{source.url}</div>
                                    </div>
                                    <button onClick={() => handleDelete(source.id)} className="text-red-500 hover:text-red-700 p-2"><Icon name="trash-2" size={18}/></button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENTE DE ETIQUETA MODIFICADO ---
        const ProductionLabel = ({ labelData, shiftHours, imageSources }) => {
            const svgRef = useRef(null);
            const order = labelData; 
            const subPiece = order.subPiecesData ? order.subPiecesData.find(sp => sp.pieza === order.piezaNombre) : (order.subPiecesData?.[0] || {});
            
            const barcodeValue = order.packageCode; 
            const fechaEntrega = order.fechaEntrega || new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toLocaleDateString('es-MX');

            // --- CÁLCULOS MATEMÁTICOS (SIN DECIMALES) ---
            const tiempo = parseFloat(subPiece?.tiempo);
            const hours = parseFloat(shiftHours) || 12;
            const pzas1hr = tiempo > 0 ? Math.round(60 / tiempo) : '-'; 
            const pzasShift = tiempo > 0 ? Math.round((hours * 60) / tiempo) : '-'; 

            // --- LIMPIEZA DE NOMBRE DE PIEZA (SOLO PRIMER PALABRA) ---
            const rawPieza = order.piezaNombre || 'ESTANDAR';
            // Divide por espacio y toma el primer elemento. Ej: "M024 (frente)" -> "M024"
            const piezaVisual = rawPieza.split(' ')[0]; 

            // --- LÓGICA DE TAMAÑO DE FUENTE PARA "PIEZA" ---
            let piezaFontSize = '28px';
            if (piezaVisual.length <= 6) {
                piezaFontSize = '64px'; // Gigante para palabras cortas
            } else if (piezaVisual.length <= 10) {
                piezaFontSize = '52px';
            } else {
                piezaFontSize = '38px';
            }

            // Gestión de Imagen Inteligente
            const [imgSrc, setImgSrc] = useState(null);
            const [currentSourceIdx, setCurrentSourceIdx] = useState(0);
            const [tryPng, setTryPng] = useState(false); 

            useEffect(() => {
                if(imageSources && imageSources.length > 0 && order.codigo) {
                    setCurrentSourceIdx(0);
                    setTryPng(false);
                    setImgSrc(`${imageSources[0].url}/${order.codigo}.jpg`);
                } else {
                    setImgSrc(null);
                }
            }, [order.codigo, imageSources]);

            const handleImgError = () => {
                if (!tryPng) {
                    setTryPng(true);
                    if(imageSources[currentSourceIdx]) {
                        setImgSrc(`${imageSources[currentSourceIdx].url}/${order.codigo}.png`);
                    }
                    return;
                }
                const nextIdx = currentSourceIdx + 1;
                if (nextIdx < imageSources.length) {
                    setCurrentSourceIdx(nextIdx);
                    setTryPng(false); 
                    setImgSrc(`${imageSources[nextIdx].url}/${order.codigo}.jpg`);
                } else {
                    setImgSrc(null); 
                }
            };

            // Barcode
            useEffect(() => {
                if (svgRef.current && barcodeValue) {
                    try {
                        JsBarcode(svgRef.current, barcodeValue, { 
                            format: "CODE128", lineColor: "#000", width: 1.6, height: 55, displayValue: false, margin: 3
                        });
                    } catch (e) { console.error("Error barcode", e); }
                }
            }, [barcodeValue]);

            return (
                <div className="label-layout">
                    {/* ZONA 1: IMAGEN (IZQUIERDA) */}
                    <div className="col-img">
                        {imgSrc ? (
                            <img src={imgSrc} onError={handleImgError} alt={order.codigo}/>
                        ) : (
                            <div className="flex flex-col items-center justify-center h-full">
                                <div className="text-slate-300 text-xs text-center font-bold">SIN<br/>IMAGEN</div>
                            </div>
                        )}
                    </div>

                    {/* ZONA 2: DATOS (CENTRO) */}
                    <div className="col-data">
                        {/* Fila 1 */}
                        <div className="lbl-row" style={{height: '17%'}}>
                            <div className="lbl-col" style={{width: '65%'}}>
                                <div className="lbl-title">MODELO</div>
                                <div className="lbl-big">{order.codigo || 'S/N'}</div>
                            </div>
                            <div className="lbl-col" style={{width: '35%'}}>
                                <div className="lbl-title">TOTAL ORDEN</div>
                                <div className="lbl-medium">{order.totalPedido || 0}</div>
                            </div>
                        </div>
                        
                        {/* Fila 2 */}
                        <div className="lbl-row" style={{height: '13%'}}>
                            <div className="lbl-col" style={{width: '70%'}}>
                                <div className="lbl-title">CLIENTE</div>
                                <div className="lbl-std truncate">{order.cliente || '---'}</div>
                            </div>
                            <div className="lbl-col" style={{width: '30%'}}>
                                <div className="lbl-title">PARTIDA</div>
                                <div className="lbl-std">{order.partida || '-'}</div>
                            </div>
                        </div>

                        {/* Fila 3: PIEZA LIMPIA Y CENTRADA (SIN TEXTO "PIEZA") */}
                        <div className="lbl-row" style={{height: '24%', backgroundColor: '#000', color: '#FFF'}}>
                            <div className="lbl-col" style={{
                                width: '100%', 
                                border: 'none', 
                                alignItems: 'center', 
                                justifyContent: 'center',
                                padding: '0',
                                display: 'flex' 
                            }}>
                                <span style={{
                                    fontFamily: "'Oswald', sans-serif",
                                    fontWeight: '700',
                                    fontSize: piezaFontSize, 
                                    lineHeight: '1',
                                    textAlign: 'center',
                                    width: '100%',
                                    whiteSpace: 'nowrap',
                                    overflow: 'hidden',
                                    textOverflow: 'ellipsis'
                                }}>{piezaVisual}</span>
                            </div>
                        </div>

                        {/* Fila 4: Paquete / Cantidad / MAQUINA BLACK */}
                        <div className="lbl-row" style={{height: '24%'}}>
                            <div className="lbl-col" style={{width: '33%', textAlign: 'center'}}>
                                <div className="lbl-title">PAQUETE</div>
                                <div className="lbl-big" style={{fontSize: '36px'}}>{order.displayPackageId}</div>
                            </div>
                            <div className="lbl-col" style={{width: '34%', backgroundColor: '#eee', textAlign: 'center'}}>
                                <div className="lbl-title">CANTIDAD</div>
                                <div className="lbl-big" style={{fontSize: '36px'}}>{order.piecesInPackage}</div>
                            </div>
                            {/* CELDA DE MÁQUINA MODIFICADA */}
                            <div className="lbl-col" style={{width: '33%', textAlign: 'center', backgroundColor: '#000', color: '#fff'}}>
                                <div className="lbl-title" style={{color: '#ccc'}}>MAQUINA</div>
                                <div className="lbl-big" style={{fontSize: '48px', color: '#fff'}}>{order.maquina || '0'}</div>
                            </div>
                        </div>

                        {/* Fila 5: Info técnica */}
                        <div className="lbl-row" style={{height: '11%'}}>
                            <div className="lbl-col" style={{width: '25%'}}>
                                <div className="lbl-title" style={{fontSize:'9px'}}>TALLA</div>
                                <div className="lbl-medium" style={{fontSize:'16px'}}>{subPiece?.talla || 'U'}</div>
                            </div>
                            <div className="lbl-col" style={{width: '25%'}}>
                                <div className="lbl-title" style={{fontSize:'9px'}}>PESO(g)</div>
                                <div className="lbl-std" style={{fontSize:'14px'}}>{subPiece?.peso || '-'}</div>
                            </div>
                            <div className="lbl-col" style={{width: '25%'}}>
                                <div className="lbl-title" style={{fontSize:'9px'}}>PZS/HR</div>
                                <div className="lbl-std" style={{fontSize:'16px'}}>{pzas1hr}</div>
                            </div>
                             <div className="lbl-col" style={{width: '25%'}}>
                                <div className="lbl-title" style={{fontSize:'9px'}}>{hours} HRS</div>
                                <div className="lbl-std" style={{fontSize:'16px'}}>{pzasShift}</div>
                            </div>
                        </div>

                        {/* Footer */}
                        <div className="lbl-row" style={{flexGrow: 1, borderBottom: 'none', alignItems: 'center'}}>
                            <div style={{fontSize: '9px', width: '100%', textAlign: 'center', fontWeight: 'bold'}}>
                                ENTREGA: {fechaEntrega}
                            </div>
                        </div>
                    </div>

                    {/* ZONA 3: BARCODE */}
                    <div className="col-barcode">
                        <div style={{
                            transform: 'rotate(90deg)', 
                            transformOrigin: 'center', 
                            width: '3.5in', 
                            display: 'flex',
                            flexDirection: 'column',
                            alignItems: 'center',
                            justifyContent: 'center'
                        }}>
                             <svg ref={svgRef} style={{width: '100%', height: 'auto'}}></svg>
                             <div style={{fontSize: '10px', fontFamily: 'monospace', marginTop: '5px'}}>{barcodeValue}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const QuickScannerModal = ({ isVisible, onClose, allOrders, onScanSaved }) => {
            const [scans, setScans] = useState([]);
            const [scanStatus, setScanStatus] = useState({ message: 'Cargando cámara...', type: 'info' });
            const [isSaving, setIsSaving] = useState(false);
            const scannerRef = useRef(null);

            useEffect(() => {
                if (isVisible) {
                    setScans([]);
                    setScanStatus({ message: 'Escanee los códigos únicos de los paquetes...', type: 'info' });
                    
                    setTimeout(() => {
                        const html5QrcodeScanner = new Html5QrcodeScanner(
                            "reader", 
                            { fps: 10, qrbox: { width: 250, height: 150 }, aspectRatio: 1.0, videoConstraints: { facingMode: "environment" } },
                            false
                        );

                        const onScanSuccess = (decodedText) => {
                            handleQuickScan(decodedText);
                            html5QrcodeScanner.pause(); 
                            setTimeout(() => html5QrcodeScanner.resume(), 1500); 
                        };

                        html5QrcodeScanner.render(onScanSuccess, (errorMessage) => {});
                        scannerRef.current = html5QrcodeScanner;
                    }, 100);
                } else {
                    if (scannerRef.current) {
                        scannerRef.current.clear().catch(err => console.error(err));
                        scannerRef.current = null;
                    }
                }
                return () => { if (scannerRef.current) scannerRef.current.clear().catch(err => {}); };
            }, [isVisible]);

            const handleQuickScan = (rawCode) => {
                if (!rawCode) return;
                const scannedCode = rawCode.trim();

                if (scans.includes(scannedCode)) {
                    setScanStatus({ message: `Código ${scannedCode} ya escaneado.`, type: 'warning' });
                    return;
                }

                let foundPackage = null;
                let foundOrder = null;

                for (const order of allOrders) {
                    if (order.progreso) {
                        const pkg = order.progreso.find(p => p.codigoUnico === scannedCode);
                        if (pkg) { foundPackage = pkg; foundOrder = order; break; }
                    }
                }

                if (!foundPackage || !foundOrder) {
                    setScanStatus({ message: `Código ${scannedCode} NO encontrado.`, type: 'error' });
                    return;
                }

                setScans(prev => [...prev, scannedCode]);
                setScanStatus({ message: `¡OK! ${foundPackage.piezaNombre} (${foundPackage.paqueteNum})`, type: 'success' });
            };

            const handleSaveAll = async () => {
                if (scans.length === 0 || isSaving) return;
                setIsSaving(true);
                const successfulScans = [];
                const failedScans = [];

                for (const scannedCode of scans) {
                    try {
                        let foundPackage = null;
                        let foundOrder = null;
                        for (const order of allOrders) {
                            if (order.progreso) {
                                const pkg = order.progreso.find(p => p.codigoUnico === scannedCode);
                                if (pkg) { foundPackage = pkg; foundOrder = order; break; }
                            }
                        }
                        if (!foundPackage) continue;

                        const globalScanCheck = await db.collection('registro_produccion').where('codigo_paquete', '==', scannedCode).get();
                        if (!globalScanCheck.empty) { failedScans.push(scannedCode); continue; }

                        await db.collection('registro_produccion').doc().set({
                            codigo_paquete: scannedCode, 
                            orderId: String(foundOrder.id), 
                            fecha: FieldValue.serverTimestamp(),
                            fecha_legible: new Date().toLocaleDateString('es-MX', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }), 
                            tejedor: "Balta",
                            tipo: "produccion",
                            modelo: foundOrder.codigo,
                            partida: foundOrder.partida,
                            paquete_indice: foundPackage.paqueteNum, 
                            paquete_total: foundPackage.paquetesDePieza,
                            piezas_en_paquete: foundPackage.cantidad
                        });
                        successfulScans.push(scannedCode);
                    } catch (error) { failedScans.push(scannedCode); }
                }
                setIsSaving(false);
                onScanSaved(); 
                onClose(); 
            };

            if (!isVisible) return null;

            return (
                <div className="fixed inset-0 bg-black/80 z-[100] flex flex-col items-center justify-center p-4">
                    <div className="w-full max-w-2xl bg-white rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[95vh]">
                        <div className="flex justify-between items-center p-4 bg-slate-800 text-white">
                            <h2 className="font-bold text-xl flex items-center gap-2"><Icon name="scan"/> ESCANEO RÁPIDO</h2>
                            <button onClick={onClose} className="bg-red-600 px-3 py-1 rounded text-sm font-bold">X</button>
                        </div>
                        <div className="flex flex-col md:flex-row flex-grow min-h-0">
                            <div className="w-full md:w-1/2 bg-black flex flex-col justify-center items-center p-2">
                                <div id="reader" className="w-full bg-black"></div>
                                <div className="mt-2 text-white text-center text-xs">{scanStatus.message}</div>
                            </div>
                            <div className="w-full md:w-1/2 flex flex-col p-4">
                                <h3 className="font-bold text-slate-700 mb-3">Leídos ({scans.length})</h3>
                                <div className="flex-grow overflow-y-auto border p-2 mb-4 bg-slate-50 h-32">
                                    {scans.map(code => <div key={code} className="text-xs font-mono border-b p-1">{code}</div>)}
                                </div>
                                <button onClick={handleSaveAll} disabled={scans.length === 0 || isSaving} className="w-full py-3 bg-green-600 text-white font-bold rounded">
                                    {isSaving ? 'GUARDANDO...' : 'GUARDAR TODO'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [orders, setOrders] = useState([]);
            const [selectedOrder, setSelectedOrder] = useState(null); 
            const [packageLabels, setPackageLabels] = useState([]); 
            const [filterText, setFilterText] = useState('');
            const [showScanner, setShowScanner] = useState(false);
            const [showConfigModal, setShowConfigModal] = useState(false);
            const [isGeneratingPdf, setIsGeneratingPdf] = useState(false); 
            const [shiftHours, setShiftHours] = useState(12);
            
            const [imageSources, setImageSources] = useState([]);
            const pdfContainerRef = useRef(null);

            useEffect(() => {
                const unsubscribe = db.collection('app_config').doc('imagenes')
                    .onSnapshot(doc => {
                        if(doc.exists && doc.data().sources) {
                            setImageSources(doc.data().sources);
                        }
                    });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                const unsubscribe = db.collection('orders').where('status', '!=', 'ARCHIVADO').onSnapshot(snapshot => {
                        const fetchedOrders = snapshot.docs.map(doc => doc.data());
                        fetchedOrders.sort((a, b) => b.id - a.id);
                        setOrders(fetchedOrders);
                    });
                return () => unsubscribe();
            }, []);
            
            useEffect(() => {
                if (selectedOrder && selectedOrder.progreso) {
                    const labels = selectedOrder.progreso.map(p => ({
                        ...selectedOrder,
                        piezaNombre: p.piezaNombre, 
                        packageIndex: p.paqueteNum,
                        totalPackages: p.paquetesDePieza,
                        piecesInPackage: p.cantidad,
                        packageCode: p.codigoUnico, 
                        displayPackageId: `${p.paqueteNum}/${p.paquetesDePieza}`
                    }));
                    setPackageLabels(labels);
                } else { setPackageLabels([]); }
            }, [selectedOrder]);

            const filteredOrders = useMemo(() => {
                if (!filterText) return orders;
                const txt = filterText.toUpperCase();
                return orders.filter(o => (o.codigo && o.codigo.includes(txt)) || (o.cliente && o.cliente.includes(txt)));
            }, [orders, filterText]);

            const handleDownloadPDF = async () => {
                if (packageLabels.length === 0) return;
                setIsGeneratingPdf(true);

                await new Promise(resolve => setTimeout(resolve, 500));
                
                const element = pdfContainerRef.current;
                if(!element) {
                    alert("Error interno: Contenedor PDF no encontrado.");
                    setIsGeneratingPdf(false);
                    return;
                }

                const opt = {
                    margin:       [0, 0], 
                    filename:     `${selectedOrder.codigo || 'orden'}_${packageLabels.length}pqts.pdf`,
                    image:        { type: 'jpeg', quality: 1.0 },
                    html2canvas:  { scale: 2, useCORS: true, logging: false, windowWidth: 1200 },
                    jsPDF:        { unit: 'in', format: [6, 4], orientation: 'landscape' }
                };

                html2pdf().set(opt).from(element).save().then(() => {
                    setIsGeneratingPdf(false);
                }).catch(err => {
                    console.error("PDF Error:", err);
                    setIsGeneratingPdf(false);
                    alert("Error al generar PDF.");
                });
            };

            return (
                <div className="flex flex-col lg:flex-row h-screen w-full">
                    {/* SIDEBAR */}
                    <div className="w-full lg:w-72 bg-slate-800 text-white flex flex-col border-r border-slate-700 shadow-xl shrink-0 h-64 lg:h-auto">
                        <div className="p-4 bg-slate-900 border-b border-slate-700">
                            <h1 className="text-xl font-bold text-yellow-400 tracking-tighter">CIRINEO v5.0</h1>
                            <input type="text" placeholder="Buscar orden..." value={filterText} onChange={e => setFilterText(e.target.value)} className="w-full mt-2 bg-slate-800 border border-slate-600 rounded p-2 text-sm" />
                            
                            <div className="mt-4 grid grid-cols-2 gap-2">
                                <div>
                                    <label className="text-[10px] text-slate-400">HORAS TURNO</label>
                                    <input type="number" value={shiftHours} onChange={e => setShiftHours(e.target.value)} className="w-full bg-slate-700 border border-slate-600 rounded p-1 text-center font-bold text-yellow-400" />
                                </div>
                                <div>
                                    <label className="text-[10px] text-slate-400">CONFIG</label>
                                    <button onClick={() => setShowConfigModal(true)} className="w-full bg-slate-700 hover:bg-slate-600 border border-slate-500 rounded p-1 text-xs font-bold flex justify-center items-center gap-1">
                                        <Icon name="settings" size={12}/> IMÁGENES
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div className="flex-grow overflow-y-auto p-2 space-y-2">
                            {filteredOrders.map(order => (
                                <div key={order.id} onClick={() => setSelectedOrder(order)} className={`p-3 rounded cursor-pointer border-l-4 transition-all ${selectedOrder?.id === order.id ? 'bg-slate-700 border-yellow-400' : 'bg-slate-800/50 border-transparent hover:bg-slate-700'}`}>
                                    <div className="font-bold text-sm">{order.codigo}</div>
                                    <div className="text-xs text-slate-400">{order.cliente}</div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* MAIN CONTENT */}
                    <div className="flex-grow bg-slate-100 flex flex-col relative overflow-hidden">
                        {/* Header */}
                        <div className="bg-white p-3 shadow-sm border-b flex justify-between items-center z-10">
                            <h2 className="font-bold text-slate-700 text-lg truncate">
                                {selectedOrder ? `${selectedOrder.codigo} - ${packageLabels.length} PAQUETES` : 'Seleccione una orden'}
                            </h2>
                            {selectedOrder && (
                                <button onClick={handleDownloadPDF} disabled={isGeneratingPdf} className={`px-4 py-2 text-white rounded font-bold text-sm flex items-center gap-2 shadow-lg transform transition active:scale-95 ${isGeneratingPdf ? 'bg-slate-400' : 'bg-red-600 hover:bg-red-700'}`}>
                                    <Icon name="file-down" size={18}/> {isGeneratingPdf ? 'GENERANDO...' : 'DESCARGAR PDF'}
                                </button>
                            )}
                        </div>

                        {/* Vista Previa */}
                        <div className="flex-grow overflow-y-auto p-4 lg:p-8 flex flex-col items-center">
                            {packageLabels.length > 0 ? (
                                <>
                                    <div className="text-xs font-bold text-slate-400 mb-2 uppercase tracking-wide">VISTA PREVIA (1 de {packageLabels.length})</div>
                                    <div className="preview-wrapper">
                                        <ProductionLabel labelData={packageLabels[0]} shiftHours={shiftHours} imageSources={imageSources} />
                                    </div>
                                    <div className="text-center text-slate-500 text-sm max-w-md">
                                        Esta es una vista previa. Al descargar PDF se generarán todas las etiquetas.
                                        {imageSources.length > 0 && <div className="text-xs text-blue-500 mt-1">Fuentes de imágenes activas: {imageSources.length}</div>}
                                    </div>
                                </>
                            ) : (
                                <div className="flex flex-col items-center justify-center h-64 text-slate-400">
                                    <Icon name="box" size={48} className="mb-2 opacity-50"/>
                                    <p>Selecciona una orden del menú</p>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* CONTENEDOR OCULTO PARA PDF */}
                    <div style={{position: 'absolute', top: 0, left: '-9999px', width: '6in'}}>
                        <div ref={pdfContainerRef}>
                            {packageLabels.map((labelData, index) => (
                                <div key={index} className="pdf-fixed-container">
                                    <ProductionLabel labelData={labelData} shiftHours={shiftHours} imageSources={imageSources} />
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* MODALES */}
                    <div className="w-full lg:w-64 bg-white border-l border-slate-200 shadow-xl z-20 shrink-0 hidden lg:flex flex-col">
                         <div className="p-4 bg-slate-50 border-b">
                            <h3 className="font-bold text-slate-700 flex items-center gap-2"><Icon name="qr-code"/> Scanner</h3>
                         </div>
                         <div className="p-4 flex-grow flex flex-col items-center justify-center">
                            <button onClick={() => setShowScanner(true)} className="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold shadow-md flex flex-col items-center gap-2">
                                <Icon name="camera" size={24}/> ABRIR ESCÁNER
                            </button>
                            <p className="text-xs text-center text-slate-400 mt-4">Escanea códigos para validar producción.</p>
                         </div>
                    </div>

                    <ImageConfigModal isVisible={showConfigModal} onClose={() => setShowConfigModal(false)} />
                    <QuickScannerModal isVisible={showScanner} onClose={() => setShowScanner(false)} allOrders={orders} onScanSaved={() => {}} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>