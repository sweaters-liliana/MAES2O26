<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hilaturas Rouss - Panel de Control</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;400;600;900&display=swap');
        body { font-family: 'Outfit', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        .card-glow { transition: all 0.3s ease; border: 1px solid #1e293b; }
        .card-glow:hover { border-color: #38bdf8; box-shadow: 0 0 20px rgba(56, 189, 248, 0.1); }
        
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const Icon = ({ name, size=20, className="" }) => {
            useEffect(() => { lucide.createIcons(); }, [name]); 
            return <i data-lucide={name} className={className} style={{width: size, height: size}}></i>;
        };

        const App = () => {
            const [requisitions, setRequisitions] = useState([]);
            const [selectedReq, setSelectedReq] = useState(null);
            const [loading, setLoading] = useState(true);
            
            // Estado para el registro de pesaje
            const [weightInput, setWeightInput] = useState("");
            const [torsionType, setTorsionType] = useState("s");

            useEffect(() => {
                const unsub = db.collection('requisitions')
                    .where('status', 'in', ['PENDING', 'IN_PROGRESS'])
                    .onSnapshot(snap => {
                        const data = snap.docs.map(d => ({...d.data(), id: d.id}));
                        setRequisitions(data.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)));
                        setLoading(false);
                    });
                return () => unsub();
            }, []);

            const handleAddWeight = async () => {
                if (!weightInput || isNaN(weightInput)) return;
                
                const grossWeight = Number(weightInput);
                const netWeight = grossWeight - (selectedReq.tareWeight || 0);
                
                const newEntry = {
                    timestamp: new Date().toISOString(),
                    grossWeight,
                    netWeight,
                    id: Date.now()
                };

                const updatedLog = { ...selectedReq.productionLog };
                if (!updatedLog[torsionType]) updatedLog[torsionType] = [];
                updatedLog[torsionType].push(newEntry);

                // Calcular nuevo progreso total
                const totalS = updatedLog.s.reduce((a, b) => a + b.netWeight, 0);
                const totalZ = updatedLog.z.reduce((a, b) => a + b.netWeight, 0);
                const deliveredKg = totalS + totalZ;

                await db.collection('requisitions').doc(selectedReq.id).update({
                    productionLog: updatedLog,
                    deliveredKg,
                    status: 'IN_PROGRESS'
                });

                setWeightInput("");
                // Actualizar localmente el seleccionado para ver el cambio inmediato
                setSelectedReq({...selectedReq, productionLog: updatedLog, deliveredKg});
            };

            const completeRequisition = async (id) => {
                if(confirm("¿Marcar esta requisición como completada y enviada a bodega?")) {
                    await db.collection('requisitions').doc(id).update({
                        status: 'COMPLETED_AND_STOCKED',
                        completedAt: new Date().toISOString()
                    });
                    setSelectedReq(null);
                }
            };

            return (
                <div className="min-h-screen flex flex-col">
                    {/* Header */}
                    <header className="bg-slate-900 border-b border-slate-800 p-4 sticky top-0 z-10 shadow-2xl">
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="bg-sky-500 p-2 rounded-lg">
                                    <Icon name="factory" className="text-white"/>
                                </div>
                                <div>
                                    <h1 className="text-xl font-black tracking-tighter text-white">HILATURAS ROUSS</h1>
                                    <p className="text-[10px] text-sky-400 font-bold uppercase tracking-widest">Sistema de Pesaje Real</p>
                                </div>
                            </div>
                            <div className="text-right">
                                <div className="text-xs text-slate-400">Requisiciones Activas</div>
                                <div className="text-xl font-mono font-bold text-white">{requisitions.length}</div>
                            </div>
                        </div>
                    </header>

                    <main className="flex-1 max-w-7xl mx-auto w-full p-4 grid grid-cols-1 lg:grid-cols-12 gap-6">
                        
                        {/* Panel Izquierdo: Lista */}
                        <div className="lg:col-span-4 space-y-4">
                            <h2 className="text-sm font-bold text-slate-400 uppercase flex items-center gap-2">
                                <Icon name="list" size={16}/> Pendientes de Surtir
                            </h2>
                            {requisitions.map(req => (
                                <div 
                                    key={req.id}
                                    onClick={() => setSelectedReq(req)}
                                    className={`p-4 rounded-xl cursor-pointer transition-all card-glow ${selectedReq?.id === req.id ? 'bg-sky-900/30 border-sky-500' : 'bg-slate-900/50'}`}
                                >
                                    <div className="flex justify-between items-start mb-2">
                                        <span className="text-[10px] bg-slate-800 px-2 py-1 rounded text-slate-300 font-mono">#{req.manualOrderId}</span>
                                        <span className={`text-[10px] font-bold px-2 py-1 rounded ${req.status === 'IN_PROGRESS' ? 'bg-amber-500/20 text-amber-500' : 'bg-emerald-500/20 text-emerald-500'}`}>
                                            {req.status === 'IN_PROGRESS' ? 'PROCESANDO' : 'NUEVA'}
                                        </span>
                                    </div>
                                    <div className="text-lg font-bold text-white truncate">{req.material}</div>
                                    <div className="flex justify-between items-end mt-4">
                                        <div className="text-xs text-slate-400">Objetivo: <span className="text-slate-200 font-bold">{req.requestedKg}kg</span></div>
                                        <div className="text-right">
                                            <div className="text-[10px] text-slate-500 uppercase">Avance</div>
                                            <div className="text-sm font-mono font-bold text-sky-400">{((req.deliveredKg || 0) / req.requestedKg * 100).toFixed(1)}%</div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>

                        {/* Panel Derecho: Detalle y Pesaje */}
                        <div className="lg:col-span-8">
                            {selectedReq ? (
                                <div className="bg-slate-900 border border-slate-800 rounded-2xl overflow-hidden shadow-2xl fade-in">
                                    {/* Cabecera Detalle */}
                                    <div className="p-6 border-b border-slate-800 bg-gradient-to-r from-slate-900 to-slate-800">
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <h3 className="text-3xl font-black text-white">{selectedReq.material}</h3>
                                                <p className="text-slate-400">Calibre: {selectedReq.calibre} | Estiraje: {selectedReq.estiraje}</p>
                                            </div>
                                            <button 
                                                onClick={() => completeRequisition(selectedReq.id)}
                                                className="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg font-bold text-sm transition-colors flex items-center gap-2">
                                                <Icon name="check-circle" size={18}/> FINALIZAR Y ENVIAR
                                            </button>
                                        </div>
                                    </div>

                                    {/* Registro de Pesaje */}
                                    <div className="p-6 grid grid-cols-1 md:grid-cols-2 gap-8">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-4">Registrar Nueva Salida</label>
                                            <div className="bg-slate-800 p-4 rounded-2xl space-y-4">
                                                <div className="flex gap-2">
                                                    <button 
                                                        onClick={() => setTorsionType('s')}
                                                        className={`flex-1 py-3 rounded-xl font-bold transition-all ${torsionType === 's' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/20' : 'bg-slate-700 text-slate-400'}`}>
                                                        Torsión S
                                                    </button>
                                                    <button 
                                                        onClick={() => setTorsionType('z')}
                                                        className={`flex-1 py-3 rounded-xl font-bold transition-all ${torsionType === 'z' ? 'bg-emerald-600 text-white shadow-lg shadow-emerald-500/20' : 'bg-slate-700 text-slate-400'}`}>
                                                        Torsión Z
                                                    </button>
                                                </div>
                                                
                                                <div className="relative">
                                                    <input 
                                                        type="number"
                                                        value={weightInput}
                                                        onChange={(e) => setWeightInput(e.target.value)}
                                                        placeholder="0.00"
                                                        className="w-full bg-slate-950 border-2 border-slate-700 rounded-xl p-6 text-4xl font-mono font-bold text-center text-white focus:border-sky-500 outline-none transition-all"
                                                    />
                                                    <div className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 font-bold">KG BRUTO</div>
                                                </div>

                                                <button 
                                                    onClick={handleAddWeight}
                                                    className="w-full bg-sky-500 hover:bg-sky-400 text-slate-900 py-4 rounded-xl font-black text-lg transition-transform active:scale-95">
                                                    REGISTRAR PESAJE
                                                </button>
                                                <p className="text-center text-[10px] text-slate-500 italic">Se restará automáticamente la tara de {selectedReq.tareWeight}kg</p>
                                            </div>
                                        </div>

                                        {/* Monitor de Progreso */}
                                        <div className="space-y-6">
                                            <label className="block text-xs font-bold text-slate-500 uppercase">Estado de Producción</label>
                                            
                                            {['s', 'z'].map(type => {
                                                const logs = selectedReq.productionLog?.[type] || [];
                                                const totalNet = logs.reduce((a,b) => a + b.netWeight, 0);
                                                const goal = selectedReq.requestedKg / 2;
                                                const pct = Math.min((totalNet / goal) * 100, 100);

                                                return (
                                                    <div key={type} className="space-y-2">
                                                        <div className="flex justify-between items-end">
                                                            <span className="text-sm font-bold uppercase tracking-wider text-slate-300">Torsión {type.toUpperCase()}</span>
                                                            <span className="font-mono text-sm text-sky-400">{totalNet.toFixed(2)} / {goal.toFixed(2)} kg</span>
                                                        </div>
                                                        <div className="h-4 bg-slate-800 rounded-full overflow-hidden border border-slate-700">
                                                            <div 
                                                                className={`h-full transition-all duration-1000 ${type === 's' ? 'bg-indigo-500' : 'bg-emerald-500'}`}
                                                                style={{width: `${pct}%`}}>
                                                            </div>
                                                        </div>
                                                        <div className="grid grid-cols-4 gap-1">
                                                            {logs.map((log, i) => (
                                                                <div key={i} className="text-[9px] bg-slate-800 text-slate-400 p-1 rounded text-center font-mono">
                                                                    {log.netWeight.toFixed(2)}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="h-full flex flex-col items-center justify-center text-slate-600 border-2 border-dashed border-slate-800 rounded-2xl p-12">
                                    <Icon name="mouse-pointer-2" size={48} className="mb-4 opacity-20"/>
                                    <p className="text-xl font-medium">Selecciona una requisición para empezar a pesar</p>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>