<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viva Rouss - Control & Requisiciones</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* Animación Absorción */
        .absorb-enter { animation: absorbAnim 0.7s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes absorbAnim {
            0% { opacity: 0; transform: scale(0.1) rotate(5deg); border-radius: 100%; }
            60% { opacity: 1; transform: scale(1.02) rotate(-1deg); border-radius: 10px; }
            100% { opacity: 1; transform: scale(1); border-radius: 0px; }
        }

        /* Inputs editables que parecen texto */
        .editable-input {
            background: transparent;
            border-bottom: 1px dashed #a5b4fc;
            width: 100%;
            outline: none;
            transition: all 0.2s;
        }
        .editable-input:focus {
            border-bottom: 2px solid #4f46e5;
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body class="text-slate-800 overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { jsPDF } = window.jspdf;

        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const Icon = ({ name, size=18, className="" }) => {
            useEffect(() => { lucide.createIcons(); }, [name]); 
            return <i data-lucide={name} className={className} style={{fontSize: size, width: size, height: size}}></i>;
        };

        const App = () => {
            // --- Estados de Datos ---
            const [rawOrders, setRawOrders] = useState([]);
            const [requisitions, setRequisitions] = useState([]); 
            const [reqMap, setReqMap] = useState({}); 

            // --- Estados de UI ---
            const [view, setView] = useState('active');
            const [zoom, setZoom] = useState(1);
            
            // --- Estados de Expansión ---
            const [expandedPackages, setExpandedPackages] = useState({});
            const [expandedFactory, setExpandedFactory] = useState({}); 

            // --- Lógica de Selección y Modal ---
            const [isSelectionMode, setIsSelectionMode] = useState(false);
            const [filterCriteria, setFilterCriteria] = useState(null); 
            const [selectedOrderIds, setSelectedOrderIds] = useState([]);
            const [showModal, setShowModal] = useState(false);
            
            // --- Datos para el Modal / PDF ---
            const [modalData, setModalData] = useState({
                orders: [],
                candidates: [], 
                selectedIdx: 0
            });

            // Estado para los valores EDITABLES
            const [editValues, setEditValues] = useState({
                name: '',
                calibre: '',
                estiraje: '',
                totalKg: 0
            });

            const [manualOrderId, setManualOrderId] = useState('');
            const [manualTare, setManualTare] = useState(1.7); 

            // 1. Cargar Órdenes
            useEffect(() => {
                const unsub = db.collection('orders').onSnapshot(snap => {
                    setRawOrders(snap.docs.map(d => ({...d.data(), uid: d.id})));
                });
                return () => unsub();
            }, []);

            // 2. Cargar Requisiciones
            useEffect(() => {
                const unsub = db.collection('requisitions').onSnapshot(snap => {
                    const reqs = snap.docs.map(d => ({...d.data(), id: d.id}));
                    setRequisitions(reqs);
                    
                    const map = {};
                    reqs.forEach(r => {
                        if (r.status !== 'COMPLETED_AND_STOCKED') {
                            if (r.orders) {
                                r.orders.forEach(o => map[o.uid] = r);
                            }
                        }
                    });
                    setReqMap(map);
                });
                return () => unsub();
            }, []);

            // 3. Efecto para actualizar los inputs editables cuando cambia el dropdown
            useEffect(() => {
                if (showModal && modalData.candidates.length > 0) {
                    const cand = modalData.candidates[modalData.selectedIdx];
                    setEditValues({
                        name: cand.name,
                        calibre: cand.calibre,
                        estiraje: cand.estiraje,
                        totalKg: Number(cand.totalKg.toFixed(2)) // Redondear inicial
                    });
                }
            }, [showModal, modalData.selectedIdx]);

            // Filtrado Principal
            const displayedOrders = useMemo(() => {
                let filtered = view === 'active' 
                    ? rawOrders.filter(o => o.status !== 'ARCHIVADO') 
                    : rawOrders.filter(o => o.status === 'ARCHIVADO');
                
                if (isSelectionMode && filterCriteria) {
                    filtered = filtered.filter(o => 
                        o.codigo === filterCriteria.codigo && 
                        o.partida === filterCriteria.partida
                    );
                }
                return filtered.sort((a,b) => (b.id || 0) - (a.id || 0));
            }, [rawOrders, view, isSelectionMode, filterCriteria]);

            // --- Funciones de Selección ---
            const toggleSelectionMode = () => {
                setIsSelectionMode(!isSelectionMode);
                setFilterCriteria(null);
                setSelectedOrderIds([]);
            };

            const handleRowClick = (order) => {
                if (!isSelectionMode) return;
                if (reqMap[order.uid]) return;

                if (!filterCriteria) {
                    setFilterCriteria({ codigo: order.codigo, partida: order.partida });
                    setSelectedOrderIds([order.uid]);
                } else {
                    if (selectedOrderIds.includes(order.uid)) {
                        setSelectedOrderIds(prev => prev.filter(id => id !== order.uid));
                    } else {
                        setSelectedOrderIds(prev => [...prev, order.uid]);
                    }
                }
            };

            const selectAllFiltered = () => {
                const validIds = displayedOrders
                    .filter(o => !reqMap[o.uid])
                    .map(o => o.uid);
                setSelectedOrderIds(validIds);
            };

            // --- Abrir Modal ---
            const handleOpenModal = () => {
                if (selectedOrderIds.length === 0) return;

                const selectedOrders = rawOrders.filter(o => selectedOrderIds.includes(o.uid));
                const referenceOrder = selectedOrders[0]; 

                if (!referenceOrder.threading || referenceOrder.threading.length === 0) {
                    alert("El pedido seleccionado no tiene configuración de hilos (threading).");
                    return;
                }

                // Generar lista de materiales candidatos
                const candidates = referenceOrder.threading.map((hilo) => {
                    const matName = hilo.material || "Sin Nombre";
                    const pct = Number(hilo.porcentaje) || 0;
                    
                    let totalMatKg = 0;
                    selectedOrders.forEach(o => {
                        let pesoOrden = 0;
                        o.progreso?.forEach(p => {
                            const def = o.subPiecesData?.find(sp => sp.pieza === p.piezaNombre);
                            pesoOrden += (Number(def?.peso || 0) * Number(p.cantidad));
                        });
                        totalMatKg += (pesoOrden * (pct / 100)) / 1000;
                    });

                    return {
                        name: matName,
                        calibre: hilo.calibre || 'S/C',
                        estiraje: hilo.estiraje || 'Std',
                        pct: pct,
                        totalKg: totalMatKg
                    };
                });

                setModalData({
                    orders: selectedOrders,
                    candidates: candidates,
                    selectedIdx: 0 
                });
                setManualOrderId('');
                setShowModal(true);
            };

            // --- Guardar en BD (y Opcional PDF) ---
            const handleProcessRequisition = async (shouldPrint) => {
                if (!manualOrderId) {
                    alert("Debes ingresar un folio o ID manual para la requisición.");
                    return;
                }

                // Usamos los valores EDITADOS, no los calculados
                const payload = {
                    createdAt: new Date().toISOString(),
                    status: 'PENDING', 
                    manualOrderId: manualOrderId,
                    tareWeight: Number(manualTare),
                    
                    // Datos EDITADOS
                    material: editValues.name,
                    calibre: editValues.calibre,
                    estiraje: editValues.estiraje,
                    requestedKg: Number(editValues.totalKg),
                    
                    orders: modalData.orders.map(o => ({ uid: o.uid, codigo: o.codigo, partida: o.partida })),
                    productionLog: { s: [], z: [] },
                    deliveredKg: 0
                };

                try {
                    await db.collection('requisitions').add(payload);
                    
                    if (shouldPrint) {
                        generatePDF(payload);
                    } else {
                        alert("Requisición guardada en el sistema correctamente.");
                    }

                    // Limpieza
                    setShowModal(false);
                    setIsSelectionMode(false);
                    setFilterCriteria(null);
                    setSelectedOrderIds([]);
                } catch (e) {
                    alert("Error: " + e.message);
                }
            };

            const generatePDF = (data) => {
                const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: [216, 93] });

                doc.setFont("helvetica", "bold");
                doc.setFontSize(14);
                doc.text("REQUISICIÓN DE HILO - VIVA ROUSS", 10, 10);
                
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 10, 16);
                doc.text(`Folio Hilatura: ${data.manualOrderId}`, 150, 10);

                doc.setDrawColor(0);
                doc.setFillColor(240, 240, 240);
                doc.rect(10, 20, 196, 18, 'F');
                
                doc.setFontSize(11);
                doc.setFont("helvetica", "bold");
                doc.text(data.material, 15, 28);
                
                doc.setFontSize(9);
                doc.setFont("helvetica", "normal");
                doc.text(`Calibre: ${data.calibre}  |  Estiraje: ${data.estiraje}`, 15, 34);
                
                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.text(`${data.requestedKg.toFixed(2)} Kg`, 190, 30, { align: 'right' });

                const half = (data.requestedKg / 2).toFixed(2);
                doc.setFontSize(10);
                doc.text(`Torsión S: ${half} Kg`, 10, 48);
                doc.text(`Torsión Z: ${half} Kg`, 80, 48);
                doc.setFont("helvetica", "normal");
                doc.text(`(Tara Ref: ${data.tareWeight} kg)`, 150, 48);

                const bodyData = data.orders.map(o => [o.codigo, o.partida]);
                doc.autoTable({
                    startY: 52,
                    head: [['Modelo', 'Partida']],
                    body: bodyData,
                    theme: 'grid',
                    styles: { fontSize: 8, cellPadding: 1 },
                    headStyles: { fillColor: [40, 40, 40] },
                    margin: { left: 10, right: 10 }
                });

                doc.save(`REQ_${data.manualOrderId}_${new Date().toLocaleDateString()}.pdf`);
            };


            return (
                <div style={{ transform: `scale(${zoom})`, transformOrigin: 'top center' }} className="min-h-screen pb-20">
                    
                    {/* Botones Zoom */}
                    <div className="fixed bottom-6 right-6 flex flex-col gap-2 z-50 no-print">
                        <button onClick={() => setZoom(z => Math.min(z+0.1, 1.3))} className="bg-white p-3 rounded-full shadow border hover:bg-slate-50"><Icon name="zoom-in"/></button>
                        <button onClick={() => setZoom(z => Math.max(z-0.1, 0.6))} className="bg-white p-3 rounded-full shadow border hover:bg-slate-50"><Icon name="zoom-out"/></button>
                        <button onClick={() => setZoom(1)} className="bg-slate-800 text-white p-3 rounded-full shadow hover:bg-slate-700 mt-2"><Icon name="refresh-ccw"/></button>
                    </div>

                    {/* Navbar Top */}
                    <div className="bg-white shadow-sm border-b sticky top-0 z-40 p-4">
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            <div>
                                <h1 className="text-xl font-black text-slate-800 flex items-center gap-2">
                                    <Icon name="layout-grid" className="text-indigo-600"/> PRODUCCIÓN
                                </h1>
                            </div>
                            
                            <div className="flex gap-3">
                                {!isSelectionMode ? (
                                    <button 
                                        onClick={toggleSelectionMode}
                                        className="bg-slate-900 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-slate-700 flex items-center gap-2 transition-all">
                                        <Icon name="check-square" size={16}/> SELECCIONAR PEDIDOS
                                    </button>
                                ) : (
                                    <div className="flex items-center gap-3 bg-indigo-50 px-2 py-1 rounded-lg border border-indigo-100">
                                        <span className="text-xs font-bold text-indigo-800 uppercase pl-2">
                                            {filterCriteria ? `Filtrando: ${filterCriteria.codigo}` : 'Selecciona un pedido base'}
                                        </span>
                                        {filterCriteria && (
                                            <>
                                                <button onClick={selectAllFiltered} className="text-xs font-bold bg-white border px-2 py-1 rounded hover:bg-indigo-100">Todas</button>
                                                <button 
                                                    onClick={handleOpenModal}
                                                    disabled={selectedOrderIds.length === 0}
                                                    className="bg-indigo-600 text-white px-3 py-1.5 rounded font-bold text-xs hover:bg-indigo-700 disabled:opacity-50">
                                                    CREAR REQUISICIÓN ({selectedOrderIds.length})
                                                </button>
                                            </>
                                        )}
                                        <button onClick={toggleSelectionMode} className="p-1 hover:bg-red-100 rounded text-red-500"><Icon name="x" size={16}/></button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Contenido Principal */}
                    <div className="p-4 max-w-7xl mx-auto">
                        
                        {/* Tabla */}
                        <div className="bg-white rounded-xl shadow-sm border overflow-hidden min-h-[500px]">
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-slate-50 text-slate-500 text-[10px] uppercase font-bold">
                                        <tr>
                                            {isSelectionMode && <th className="p-3 w-10 text-center">Select</th>}
                                            <th className="p-3">Modelo</th>
                                            <th className="p-3">Partida</th>
                                            <th className="p-3 text-center">Pzas</th>
                                            <th className="p-3 text-center">Peso</th>
                                            <th className="p-3 text-center">Estado Licra</th>
                                            <th className="p-3 text-right">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y">
                                        {displayedOrders.length === 0 && (
                                            <tr><td colSpan="7" className="p-8 text-center text-slate-400">No hay pedidos que coincidan.</td></tr>
                                        )}
                                        {displayedOrders.map(o => {
                                            const activeReq = reqMap[o.uid]; 
                                            const isSelected = selectedOrderIds.includes(o.uid);
                                            const isLocked = activeReq && isSelectionMode; 

                                            let pesoTotal = 0;
                                            o.progreso?.forEach(p => {
                                                const d = o.subPiecesData?.find(x=>x.pieza===p.piezaNombre);
                                                pesoTotal += (Number(d?.peso||0) * Number(p.cantidad));
                                            });

                                            return (
                                                <React.Fragment key={o.uid}>
                                                    <tr 
                                                        onClick={() => !isLocked && handleRowClick(o)}
                                                        className={`
                                                            group transition-colors border-b last:border-0
                                                            ${isSelectionMode && !isLocked ? 'cursor-pointer hover:bg-indigo-50' : ''}
                                                            ${isSelected ? 'bg-indigo-50' : 'bg-white'}
                                                            ${isLocked ? 'opacity-50 bg-slate-50 cursor-not-allowed grayscale' : ''}
                                                        `}
                                                    >
                                                        {isSelectionMode && (
                                                            <td className="p-3 text-center">
                                                                {!isLocked && (
                                                                    <div className={`w-5 h-5 rounded border mx-auto flex items-center justify-center ${isSelected ? 'bg-indigo-600 border-indigo-600' : 'border-slate-300 bg-white'}`}>
                                                                        {isSelected && <Icon name="check" size={14} className="text-white"/>}
                                                                    </div>
                                                                )}
                                                                {isLocked && <Icon name="lock" size={14} className="text-slate-400 mx-auto"/>}
                                                            </td>
                                                        )}
                                                        <td className="p-3 font-black text-slate-700">{o.codigo}</td>
                                                        <td className="p-3 text-slate-500">{o.partida}</td>
                                                        <td className="p-3 text-center font-bold">{o.progreso?.length || 0}</td>
                                                        <td className="p-3 text-center font-mono">{(pesoTotal/1000).toFixed(2)}</td>
                                                        <td className="p-3 text-center">
                                                            {activeReq ? (
                                                                <span className="text-[10px] font-bold bg-amber-100 text-amber-700 px-2 py-1 rounded border border-amber-200">
                                                                    EN HILATURA
                                                                </span>
                                                            ) : (
                                                                <span className="text-[10px] text-slate-400">S/P</span>
                                                            )}
                                                        </td>
                                                        <td className="p-3 text-right">
                                                            <div className="flex justify-end gap-1">
                                                                <button onClick={(e) => { e.stopPropagation(); setExpandedPackages(prev => ({...prev, [o.uid]: !prev[o.uid]})); }} className="p-2 hover:bg-slate-100 rounded text-indigo-600"><Icon name="package" size={16}/></button>
                                                                
                                                                {activeReq && (
                                                                    <button 
                                                                        onClick={(e) => { e.stopPropagation(); setExpandedFactory(prev => ({...prev, [o.uid]: !prev[o.uid]})); }}
                                                                        className="p-2 hover:bg-amber-100 bg-amber-50 rounded text-amber-600 relative animate-pulse">
                                                                        <Icon name="factory" size={16}/>
                                                                    </button>
                                                                )}
                                                            </div>
                                                        </td>
                                                    </tr>

                                                    {/* EXPANSION 1: PAQUETES (Normal) */}
                                                    {expandedPackages[o.uid] && (
                                                        <tr className="bg-slate-50 shadow-inner">
                                                            <td colSpan={isSelectionMode ? 7 : 6} className="p-4">
                                                                <div className="text-xs font-bold text-indigo-900 mb-2">Desglose de Paquetes</div>
                                                                <div className="grid grid-cols-4 md:grid-cols-8 gap-2">
                                                                    {o.progreso?.map((p, i) => (
                                                                        <div key={i} className={`p-2 rounded border text-center text-xs ${p.finished ? 'bg-emerald-100 border-emerald-300' : 'bg-white'}`}>
                                                                            <div className="font-bold">{p.piezaNombre}</div>
                                                                            <div className="text-[10px]">{p.cantidad} pzas</div>
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    )}

                                                    {/* EXPANSION 3: HILATURAS ROUSS */}
                                                    {expandedFactory[o.uid] && activeReq && (
                                                        <tr className="bg-amber-50 shadow-inner border-y border-amber-200">
                                                            <td colSpan={isSelectionMode ? 7 : 6} className="p-0">
                                                                <div className="p-4 flex flex-col md:flex-row gap-6">
                                                                    <div className="w-full md:w-1/3 border-r border-amber-200 pr-4">
                                                                        <h4 className="font-black text-amber-900 text-sm flex items-center gap-2 mb-2">
                                                                            <Icon name="truck" size={16}/> ESTATUS HILATURA
                                                                        </h4>
                                                                        <div className="text-xs text-amber-800 mb-1">Folio Req: <b>{activeReq.manualOrderId}</b></div>
                                                                        <div className="text-xs text-amber-800 mb-3">Material: <b>{activeReq.material}</b></div>
                                                                        
                                                                        <div className="text-[10px] uppercase font-bold text-slate-400">Total Solicitado</div>
                                                                        <div className="text-2xl font-black text-slate-800">{activeReq.requestedKg.toFixed(2)} <span className="text-sm text-slate-500">Kg</span></div>
                                                                    </div>

                                                                    <div className="w-full md:w-2/3 flex flex-col justify-center space-y-4">
                                                                        {(() => {
                                                                            const prodS = activeReq.productionLog?.s || [];
                                                                            const prodZ = activeReq.productionLog?.z || [];
                                                                            
                                                                            const kgS = prodS.reduce((a,b) => a + (b.netWeight || 0), 0);
                                                                            const kgZ = prodZ.reduce((a,b) => a + (b.netWeight || 0), 0);
                                                                            const targetHalf = activeReq.requestedKg / 2;
                                                                            
                                                                            const pctS = Math.min((kgS / targetHalf) * 100, 100);
                                                                            const pctZ = Math.min((kgZ / targetHalf) * 100, 100);

                                                                            return (
                                                                                <>
                                                                                    <div>
                                                                                        <div className="flex justify-between text-xs font-bold mb-1">
                                                                                            <span className="text-indigo-700">Torsión S</span>
                                                                                            <span className="text-slate-500">{kgS.toFixed(2)} / {targetHalf.toFixed(2)} Kg</span>
                                                                                        </div>
                                                                                        <div className="w-full bg-white h-3 rounded-full border border-amber-200 overflow-hidden">
                                                                                            <div className="h-full bg-indigo-500 transition-all duration-1000" style={{width: `${pctS}%`}}></div>
                                                                                        </div>
                                                                                    </div>
                                                                                    
                                                                                    <div>
                                                                                        <div className="flex justify-between text-xs font-bold mb-1">
                                                                                            <span className="text-emerald-700">Torsión Z</span>
                                                                                            <span className="text-slate-500">{kgZ.toFixed(2)} / {targetHalf.toFixed(2)} Kg</span>
                                                                                        </div>
                                                                                        <div className="w-full bg-white h-3 rounded-full border border-amber-200 overflow-hidden">
                                                                                            <div className="h-full bg-emerald-500 transition-all duration-1000" style={{width: `${pctZ}%`}}></div>
                                                                                        </div>
                                                                                    </div>
                                                                                </>
                                                                            );
                                                                        })()}
                                                                    </div>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    )}
                                                </React.Fragment>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    {/* MODAL ABSORCIÓN (Confirmación de Requisición) */}
                    {showModal && (
                        <div className="fixed inset-0 z-[100] bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden absorb-enter border border-slate-200">
                                <div className="bg-slate-900 p-6 text-white relative">
                                    <button onClick={() => setShowModal(false)} className="absolute top-4 right-4 text-slate-400 hover:text-white"><Icon name="x"/></button>
                                    <h2 className="text-2xl font-black italic">HACER PEDIDO</h2>
                                    <p className="text-slate-400 text-xs mt-1">Selecciona y edita los datos antes de guardar</p>
                                </div>
                                
                                <div className="p-6 space-y-6">
                                    {/* Input Manual Folio */}
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Folio / ID Hilatura (Obligatorio)</label>
                                        <input 
                                            autoFocus
                                            type="text" 
                                            value={manualOrderId}
                                            onChange={e => setManualOrderId(e.target.value)}
                                            placeholder="Ej: REQ-2024-001"
                                            className="w-full p-3 bg-slate-50 border-2 border-slate-200 rounded-lg font-mono text-lg font-bold text-slate-800 focus:border-indigo-500 outline-none"
                                        />
                                    </div>

                                    {/* SELECCIONADOR DE HILO */}
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Selecciona la Licra a pedir:</label>
                                        <select 
                                            value={modalData.selectedIdx}
                                            onChange={(e) => setModalData({...modalData, selectedIdx: Number(e.target.value)})}
                                            className="w-full p-3 bg-white border-2 border-indigo-100 rounded-lg font-bold text-slate-800 focus:border-indigo-500 outline-none mb-4">
                                            {modalData.candidates.map((cand, idx) => (
                                                <option key={idx} value={idx}>
                                                    {cand.name} (Calculado: {cand.totalKg.toFixed(2)} Kg)
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    {/* CAMPOS EDITABLES */}
                                    <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 transition-all">
                                        <div className="flex justify-between items-start gap-4 mb-2">
                                            <div className="flex-1">
                                                <div className="text-[10px] uppercase font-bold text-indigo-400 mb-1">Nombre Material</div>
                                                <input 
                                                    type="text" 
                                                    value={editValues.name}
                                                    onChange={e => setEditValues({...editValues, name: e.target.value})}
                                                    className="editable-input font-black text-indigo-900 text-sm"
                                                />
                                            </div>
                                            <div className="w-24 text-right">
                                                <div className="text-[10px] font-bold text-slate-400 mb-1">TOTAL KG</div>
                                                <input 
                                                    type="number" 
                                                    step="0.01"
                                                    value={editValues.totalKg}
                                                    onChange={e => setEditValues({...editValues, totalKg: e.target.value})}
                                                    className="editable-input text-3xl font-black text-slate-800 text-right p-0"
                                                />
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-2 gap-4 mt-3">
                                            <div>
                                                <div className="text-[10px] uppercase font-bold text-indigo-400 mb-1">Calibre</div>
                                                <input 
                                                    type="text" 
                                                    value={editValues.calibre}
                                                    onChange={e => setEditValues({...editValues, calibre: e.target.value})}
                                                    className="editable-input text-xs font-bold text-indigo-900"
                                                />
                                            </div>
                                            <div>
                                                <div className="text-[10px] uppercase font-bold text-indigo-400 mb-1">Estiraje</div>
                                                <input 
                                                    type="text" 
                                                    value={editValues.estiraje}
                                                    onChange={e => setEditValues({...editValues, estiraje: e.target.value})}
                                                    className="editable-input text-xs font-bold text-indigo-900"
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    {/* Tara Config */}
                                    <div className="flex items-center justify-between p-3 border rounded bg-slate-50">
                                        <span className="text-xs text-slate-500 font-bold">Peso Tara (Bobina + Cartón)</span>
                                        <div className="flex items-center gap-2">
                                            <input 
                                                type="number" 
                                                step="0.1" 
                                                value={manualTare}
                                                onChange={e => setManualTare(e.target.value)}
                                                className="w-16 p-1 text-center font-bold border rounded"
                                            />
                                            <span className="text-xs font-bold">Kg</span>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-4 text-center">
                                        <div className="bg-slate-100 p-2 rounded">
                                            <div className="text-[10px] text-slate-400 uppercase">Torsión S</div>
                                            <div className="font-bold">{(editValues.totalKg / 2).toFixed(2)} Kg</div>
                                        </div>
                                        <div className="bg-slate-100 p-2 rounded">
                                            <div className="text-[10px] text-slate-400 uppercase">Torsión Z</div>
                                            <div className="font-bold">{(editValues.totalKg / 2).toFixed(2)} Kg</div>
                                        </div>
                                    </div>
                                </div>

                                <div className="p-6 bg-slate-50 border-t flex flex-col sm:flex-row justify-end gap-3">
                                    <button onClick={() => setShowModal(false)} className="px-4 py-2 text-sm font-bold text-slate-500 hover:text-slate-800">CANCELAR</button>
                                    
                                    <button 
                                        onClick={() => handleProcessRequisition(false)}
                                        className="bg-white border-2 border-slate-900 text-slate-900 px-4 py-2 rounded-xl font-bold text-sm hover:bg-slate-50 flex justify-center items-center gap-2">
                                        <Icon name="save" size={16}/> SOLO GUARDAR
                                    </button>

                                    <button 
                                        onClick={() => handleProcessRequisition(true)}
                                        className="bg-slate-900 text-white px-4 py-2 rounded-xl font-bold text-sm shadow-xl hover:bg-slate-800 flex justify-center items-center gap-2 active:scale-95 transition-transform">
                                        <Icon name="file-down" size={16}/> GUARDAR Y PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>